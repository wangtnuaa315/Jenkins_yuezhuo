/**
 * ============================================================================
 * Yuezhuo æ’ä»¶æ‰“åŒ…ä»»åŠ¡
 * ============================================================================
 * 
 * ã€åŠŸèƒ½è¯´æ˜ã€‘
 * - ä»å¤é€‰æ¡†é€‰æ‹©è¦æ‰“åŒ…çš„æ’ä»¶
 * - æ”¯æŒé€‰æ‹©å¤šä¸ªæ’ä»¶åŒæ—¶æ‰“åŒ…
 * - æ”¯æŒä¸€é”®æ‰“åŒ…æ‰€æœ‰æ’ä»¶
 * - è‡ªåŠ¨è¿½åŠ æ—¶é—´æˆ³åˆ°ç‰ˆæœ¬å·
 * - å½’æ¡£ .tgz æ–‡ä»¶åˆ°æ•°æ®ç›˜
 * 
 * ã€ä¾èµ–å…³ç³»ã€‘
 * - ä¾èµ–ï¼šyuezhuo-main-buildï¼ˆå¿…é¡»å…ˆæ„å»ºä¸»å·¥ç¨‹ï¼‰
 * - å¦‚ä¸»å·¥ç¨‹æœªæ„å»ºï¼Œä»»åŠ¡ä¼šæŠ¥é”™æç¤º
 * 
 * ã€è¿è¡Œé¢‘ç‡ã€‘
 * - æ—¥å¸¸æ‰“åŒ…ï¼Œå¯é¢‘ç¹è¿è¡Œ
 * 
 * ã€åˆ¶å“è¾“å‡ºã€‘
 * /mnt/sdb3/Jenkins_Yuezhuo/
 * 
 * ã€ç»´æŠ¤ä¿¡æ¯ã€‘
 * åˆ›å»ºæ—¶é—´ï¼š2026-01-16
 * ä¾èµ–æ’ä»¶ï¼šActive Choices
 * ============================================================================
 */

import groovy.json.JsonSlurper

pipeline {
    agent any

    parameters {
        // æ’ä»¶å¤é€‰æ¡† - åŠ¨æ€è¯»å–ç›®å½•
        activeChoice(
            name: 'SELECTED_PLUGINS',
            description: 'é€‰æ‹©è¦æ‰“åŒ…çš„æ’ä»¶ï¼ˆå¯å¤šé€‰ï¼‰',
            choiceType: 'PT_CHECKBOX',
            filterable: true,
            script: [
                $class: 'GroovyScript',
                script: [
                    sandbox: false,
                    script: '''
                        def pluginsDir = new File("/mnt/sdb3/yuezhuo-workspace/yuezhuo-plugins/@huaiye")
                        if (pluginsDir.exists()) {
                            def plugins = pluginsDir.listFiles()
                                .findAll { it.isDirectory() }
                                .collect { it.name }
                                .sort()
                            return plugins
                        }
                        return ["æ’ä»¶ç›®å½•ä¸å­˜åœ¨ï¼Œè¯·å…ˆè¿è¡Œä¸»å·¥ç¨‹æ„å»º"]
                    '''
                ],
                fallbackScript: [
                    sandbox: false,
                    script: 'return ["plugin-message-queue"]'
                ]
            ]
        )
        
        string(
            name: 'PLUGINS_REPO',
            defaultValue: 'http://192.168.1.6:9000/innovation/yuezhuo-plugins.git',
            description: 'æ’ä»¶ä»“åº“åœ°å€'
        )
        string(
            name: 'PLUGINS_BRANCH',
            defaultValue: 'master',
            description: 'æ’ä»¶ä»“åº“åˆ†æ”¯'
        )
        booleanParam(
            name: 'UPDATE_PLUGINS_REPO',
            defaultValue: true,
            description: 'æ›´æ–°æ’ä»¶ä»“åº“ä»£ç '
        )
        booleanParam(
            name: 'BUILD_ALL',
            defaultValue: false,
            description: 'å¿½ç•¥å¤é€‰æ¡†ï¼Œæ‰“åŒ…æ‰€æœ‰æ’ä»¶'
        )
        string(
            name: 'EMAIL_RECIPIENTS',
            defaultValue: 'wangting@huaiye.com.cn',
            description: 'é‚®ä»¶æ”¶ä»¶äººï¼ˆå¤šä¸ªç”¨é€—å·åˆ†éš”ï¼‰'
        )
    }

    environment {
        // å…±äº«å·¥ä½œç›®å½•
        SHARED_WORKSPACE = '/mnt/sdb3/yuezhuo-workspace'
        YUEZHUO_DIR = "${SHARED_WORKSPACE}/yuezhuo"
        PLUGINS_DIR = "${SHARED_WORKSPACE}/yuezhuo-plugins"
        ARTIFACTS_DIR = '/mnt/sdb3/Jenkins_Yuezhuo'
        // Git å‡­è¯ ID
        GIT_CREDENTIALS = 'yuezhuo-git-credentials'
    }

    stages {
        stage('ç¯å¢ƒæ£€æŸ¥') {
            steps {
                script {
                    sh '''
                        echo "======== ç¯å¢ƒä¿¡æ¯ ========"
                        echo "Node.js ç‰ˆæœ¬: $(node -v)"
                        echo "Yarn ç‰ˆæœ¬: $(yarn -v)"
                        echo "å…±äº«å·¥ä½œç›®å½•: ${SHARED_WORKSPACE}"
                        echo "========================="
                    '''
                }
            }
        }

        stage('æ£€æŸ¥ä¸»å·¥ç¨‹') {
            steps {
                script {
                    def buildMarker = "${env.YUEZHUO_DIR}/.build_complete"
                    def markerExists = sh(script: "test -f ${buildMarker} && echo 'yes' || echo 'no'", returnStdout: true).trim()
                    
                    if (markerExists == 'no') {
                        error "ä¸»å·¥ç¨‹å°šæœªæ„å»ºï¼è¯·å…ˆè¿è¡Œ yuezhuo-main-build ä»»åŠ¡ã€‚"
                    }
                    
                    echo "ä¸»å·¥ç¨‹å·²æ„å»ºï¼Œç»§ç»­..."
                    sh "cat ${buildMarker}"
                }
            }
        }

        stage('æ›´æ–°æ’ä»¶ä»“åº“') {
            when {
                expression { params.UPDATE_PLUGINS_REPO == true }
            }
            steps {
                script {
                    sh "mkdir -p ${PLUGINS_DIR}"
                    
                    dir(env.PLUGINS_DIR) {
                        echo "æ›´æ–°æ’ä»¶ä»“åº“..."
                        // ä½¿ç”¨ checkout ç¡®ä¿å‡­è¯æ­£ç¡®ä¼ é€’
                        checkout([
                            $class: 'GitSCM',
                            branches: [[name: "*/${params.PLUGINS_BRANCH}"]],
                            extensions: [],
                            userRemoteConfigs: [[
                                url: params.PLUGINS_REPO,
                                credentialsId: env.GIT_CREDENTIALS
                            ]]
                        ])
                        
                        env.PLUGINS_COMMIT = sh(script: 'git rev-parse --short HEAD', returnStdout: true).trim()
                        echo "æ’ä»¶ä»“åº“ Commit: ${env.PLUGINS_COMMIT}"
                    }
                }
            }
        }

        stage('ç¡®å®šæ‰“åŒ…æ’ä»¶') {
            steps {
                script {
                    def pluginList = []
                    
                    if (params.BUILD_ALL) {
                        // æ‰“åŒ…æ‰€æœ‰æ’ä»¶
                        def plugins = sh(
                            script: "ls -1 ${PLUGINS_DIR}/@huaiye/ 2>/dev/null | sort",
                            returnStdout: true
                        ).trim()
                        pluginList = plugins.split('\n').toList()
                        echo "æ‰“åŒ…æ‰€æœ‰æ’ä»¶: ${pluginList.size()} ä¸ª"
                    } else {
                        // ä½¿ç”¨å¤é€‰æ¡†é€‰æ‹©çš„æ’ä»¶
                        def selected = params.SELECTED_PLUGINS
                        if (selected) {
                            pluginList = selected.split(',').collect { it.trim() }.findAll { it }
                        }
                        
                        if (pluginList.isEmpty()) {
                            error "è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªæ’ä»¶æˆ–å‹¾é€‰\"æ‰“åŒ…æ‰€æœ‰æ’ä»¶\""
                        }
                        echo "é€‰ä¸­æ’ä»¶: ${pluginList.join(', ')}"
                    }
                    
                    env.PLUGIN_LIST = pluginList.join('\n')
                    env.PLUGIN_COUNT = pluginList.size().toString()
                }
            }
        }

        stage('æ‹·è´æ’ä»¶åˆ°ä¸»é¡¹ç›®') {
            steps {
                script {
                    def plugins = env.PLUGIN_LIST.split('\n')
                    
                    // ç¡®ä¿ç›®å½•å­˜åœ¨ï¼ˆä¸æ¸…ç©ºï¼Œä¿ç•™ä¸»å·¥ç¨‹è‡ªå¸¦çš„æ’ä»¶å¦‚ plugin-license-managerï¼‰
                    sh """
                        echo "ç¡®ä¿æ’ä»¶ç›®å½•å­˜åœ¨..."
                        mkdir -p ${YUEZHUO_DIR}/packages/plugins/@huaiye
                    """
                    
                    // æ‹·è´ç”¨æˆ·é€‰æ‹©çš„æ’ä»¶ï¼ˆå…ˆåˆ é™¤æ—§ç‰ˆæœ¬å†æ‹·è´æ–°ç‰ˆæœ¬ï¼‰
                    echo "======== æ‹·è´ç”¨æˆ·é€‰æ‹©çš„æ’ä»¶ ========"
                    for (plugin in plugins) {
                        plugin = plugin.trim()
                        if (!plugin) continue
                        
                        sh """
                            echo "æ‹·è´: ${plugin}"
                            rm -rf ${YUEZHUO_DIR}/packages/plugins/@huaiye/${plugin}
                            cp -r ${PLUGINS_DIR}/@huaiye/${plugin} ${YUEZHUO_DIR}/packages/plugins/@huaiye/
                        """
                    }
                    
                    echo "æ’ä»¶æ‹·è´å®Œæˆ"
                }
            }
        }
        
        stage('æ ¡éªŒæ’ä»¶é…ç½®') {
            steps {
                script {
                    def plugins = env.PLUGIN_LIST.split('\n')
                    def invalidPlugins = []
                    
                    echo "======== æ ¡éªŒæ’ä»¶ package.json é…ç½®ï¼ˆéç©ºæ ¡éªŒï¼‰========"
                    
                    for (plugin in plugins) {
                        plugin = plugin.trim()
                        if (!plugin) continue
                        
                        def packageJsonPath = "${env.YUEZHUO_DIR}/packages/plugins/@huaiye/${plugin}/package.json"
                        def exists = sh(script: "test -f ${packageJsonPath} && echo 'yes' || echo 'no'", returnStdout: true).trim()
                        
                        if (exists == 'yes') {
                            // ä½¿ç”¨ jq æ£€æŸ¥ name å­—æ®µå’Œ huaiye å­—æ®µåŠå…¶å­å­—æ®µæ˜¯å¦å­˜åœ¨ä¸”éç©º
                            def validationResult = sh(
                                script: """
                                    jq -e '
                                        (.name | type == "string" and startswith("@huaiye/")) and
                                        .huaiye != null and
                                        (.huaiye.pluginCode | type == "string" and length > 0) and
                                        (.huaiye.mgmtCategory | type == "string" and length > 0) and
                                        (.huaiye.userCategory | type == "array" and length > 0) and
                                        (.huaiye.func | type == "string" and length > 0) and
                                        (.huaiye.owner | type == "string" and length > 0) and
                                        (.huaiye.lifecycle | type == "string" and length > 0)
                                    ' ${packageJsonPath} > /dev/null 2>&1 && echo 'valid' || echo 'invalid'
                                """,
                                returnStdout: true
                            ).trim()
                            
                            if (validationResult == 'valid') {
                                echo "âœ… ${plugin}: é…ç½®æ­£ç¡®"
                            } else {
                                // è·å–è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
                                def missingFields = []
                                
                                def fields = [
                                    ['pluginCode', 'string'],
                                    ['mgmtCategory', 'string'],
                                    ['userCategory', 'array'],
                                    ['func', 'string'],
                                    ['owner', 'string'],
                                    ['lifecycle', 'string']
                                ]
                                
                                // é¦–å…ˆæ£€æŸ¥ name å­—æ®µæ˜¯å¦ä»¥ @huaiye/ å¼€å¤´
                                def nameValid = sh(
                                    script: "jq -e '.name | type == \"string\" and startswith(\"@huaiye/\")' ${packageJsonPath} > /dev/null 2>&1 && echo 'yes' || echo 'no'",
                                    returnStdout: true
                                ).trim()
                                
                                if (nameValid == 'no') {
                                    def actualName = sh(
                                        script: "jq -r '.name // \"(æœªè®¾ç½®)\"' ${packageJsonPath}",
                                        returnStdout: true
                                    ).trim()
                                    invalidPlugins.add("${plugin} (name å­—æ®µå¿…é¡»ä»¥ @huaiye/ å¼€å¤´ï¼Œå½“å‰å€¼: ${actualName})")
                                    echo "âŒ ${plugin}: name å­—æ®µå¿…é¡»ä»¥ @huaiye/ å¼€å¤´ï¼Œå½“å‰å€¼: ${actualName}"
                                }
                                // æ£€æŸ¥ huaiye å­—æ®µæ˜¯å¦å­˜åœ¨
                                else {
                                    def hasHuaiye = sh(
                                        script: "jq -e '.huaiye != null' ${packageJsonPath} > /dev/null 2>&1 && echo 'yes' || echo 'no'",
                                        returnStdout: true
                                    ).trim()
                                
                                if (hasHuaiye == 'no') {
                                    invalidPlugins.add("${plugin} (ç¼ºå°‘ huaiye å­—æ®µ)")
                                    echo "âŒ ${plugin}: ç¼ºå°‘ huaiye å­—æ®µ"
                                } else {
                                    for (fieldInfo in fields) {
                                        def fieldName = fieldInfo[0]
                                        def fieldType = fieldInfo[1]
                                        def checkCmd = fieldType == 'array' 
                                            ? "jq -e '.huaiye.${fieldName} | type == \"array\" and length > 0' ${packageJsonPath}"
                                            : "jq -e '.huaiye.${fieldName} | type == \"string\" and length > 0' ${packageJsonPath}"
                                        
                                        def fieldValid = sh(
                                            script: "${checkCmd} > /dev/null 2>&1 && echo 'yes' || echo 'no'",
                                            returnStdout: true
                                        ).trim()
                                        
                                        if (fieldValid == 'no') {
                                            missingFields.add(fieldName)
                                        }
                                    }
                                    
                                    invalidPlugins.add("${plugin} (å­—æ®µç¼ºå¤±æˆ–ä¸ºç©º: ${missingFields.join(', ')})")
                                    echo "âŒ ${plugin}: å­—æ®µç¼ºå¤±æˆ–ä¸ºç©º: ${missingFields.join(', ')}"
                                }
                                }  // é—­åˆ else (nameValid)
                            }
                        } else {
                            invalidPlugins.add("${plugin} (package.json ä¸å­˜åœ¨)")
                            echo "âŒ ${plugin}: package.json æ–‡ä»¶ä¸å­˜åœ¨"
                        }
                    }
                    
                    if (invalidPlugins.size() > 0) {
                        echo """
                        ========================================
                        âŒ ä»¥ä¸‹æ’ä»¶é…ç½®ä¸å®Œæ•´ï¼š
                        ${invalidPlugins.join('\n')}
                        ========================================
                        """
                        // æ ¡éªŒå¤±è´¥æ—¶ä¸­æ­¢æ„å»º
                        error "æ’ä»¶é…ç½®æ ¡éªŒå¤±è´¥ï¼Œè¯·å®Œå–„ package.json ä¸­çš„ huaiye å­—æ®µ"
                    } else {
                        echo "âœ… æ‰€æœ‰æ’ä»¶é…ç½®æ ¡éªŒé€šè¿‡"
                    }
                }
            }
        }

        stage('é‡æ–°å®‰è£…ä¾èµ–') {
            steps {
                dir(env.YUEZHUO_DIR) {
                    sh '''
                        echo "======== é‡æ–°å®‰è£…ä¾èµ– ========"
                        yarn install --frozen-lockfile || yarn install
                        echo "ä¾èµ–å®‰è£…å®Œæˆ"
                    '''
                }
            }
        }

        stage('æ„å»ºæ‰“åŒ…') {
            steps {
                script {
                    def plugins = env.PLUGIN_LIST.split('\n')
                    def successCount = 0
                    def failedPlugins = []
                    def buildTimestamp = new Date().format('yyyyMMdd.HHmmss')
                    def pluginResults = []  // æ”¶é›†æ¯ä¸ªæ’ä»¶çš„æ„å»ºç»“æœ
                    def buildStartTime = System.currentTimeMillis()
                    
                    dir(env.YUEZHUO_DIR) {
                        // æ¸…ç†æ—§çš„ tar åˆ¶å“ï¼Œé¿å…å½’æ¡£æ—¶åŒ…å«æ—§æ–‡ä»¶
                        sh """
                            echo "æ¸…ç†æ—§çš„ tar åˆ¶å“..."
                            rm -rf storage/tar/@huaiye
                            mkdir -p storage/tar/@huaiye
                        """
                        
                        for (plugin in plugins) {
                            plugin = plugin.trim()
                            if (!plugin) continue
                            
                            def fullName = "@huaiye/${plugin}"
                            def pluginPath = "packages/plugins/@huaiye/${plugin}"
                            def pluginStartTime = System.currentTimeMillis()
                            def pluginVersion = "unknown"
                            def pluginError = ""
                            def pluginStatus = "success"
                            
                            echo "======== å¼€å§‹å¤„ç†: ${fullName} ========"
                            
                            try {
                                // è·å–ç‰ˆæœ¬å·
                                pluginVersion = sh(
                                    script: "cat ${pluginPath}/package.json | grep '\"version\"' | head -1 | sed 's/.*\"version\": \"\\([^\"]*\\)\".*/\\1/'",
                                    returnStdout: true
                                ).trim()
                                
                                // 0. ä¿®æ”¹ç‰ˆæœ¬å·ï¼ˆè¿½åŠ æ—¶é—´æˆ³ï¼‰
                                sh """
                                    cd ${pluginPath}
                                    
                                    # è·å–å½“å‰ç‰ˆæœ¬å·
                                    current_version=\$(cat package.json | grep '"version"' | head -1 | sed 's/.*"version": "\\([^"]*\\)".*/\\1/')
                                    echo "å½“å‰ç‰ˆæœ¬: \$current_version"
                                    
                                    # è¿½åŠ æ—¶é—´æˆ³
                                    new_version="\${current_version}.${buildTimestamp}"
                                    echo "æ–°ç‰ˆæœ¬: \$new_version"
                                    
                                    # ä¿®æ”¹ package.json
                                    sed -i "s/\\"version\\": \\"[^\\"]*\\"/\\"version\\": \\"\$new_version\\"/" package.json
                                    
                                    # éªŒè¯ä¿®æ”¹
                                    grep '"version"' package.json
                                """
                                
                                pluginVersion = "${pluginVersion}.${buildTimestamp}"
                                
                                // 1. åˆ›å»º/æ³¨å†Œæ’ä»¶
                                sh "yarn pm create ${fullName} || true"
                                
                                // 2. æ„å»º
                                sh "yarn build ${fullName} --no-dts"
                                
                                // 3. æ‰“åŒ…
                                sh "yarn nocobase tar ${fullName}"
                                
                                successCount++
                                echo "âœ… ${fullName} æ‰“åŒ…æˆåŠŸ"
                            } catch (Exception e) {
                                failedPlugins.add(plugin)
                                pluginStatus = "failed"
                                pluginError = e.message?.take(100) ?: "Unknown error"
                                echo "âŒ ${fullName} æ‰“åŒ…å¤±è´¥: ${e.message}"
                            }
                            
                            def pluginDuration = (System.currentTimeMillis() - pluginStartTime) / 1000
                            pluginResults.add([
                                name: fullName,
                                version: pluginVersion,
                                status: pluginStatus,
                                error: pluginError,
                                duration: pluginDuration as int
                            ])
                        }
                    }
                    
                    def totalDuration = (System.currentTimeMillis() - buildStartTime) / 1000
                    
                    env.SUCCESS_COUNT = successCount.toString()
                    env.FAILED_PLUGINS = failedPlugins.join(',')
                    env.TOTAL_DURATION = totalDuration.toString()
                    
                    // ä¿å­˜æ’ä»¶ç»“æœä¸º JSON ä¾›æŠ¥å‘Šä½¿ç”¨
                    env.PLUGIN_RESULTS = groovy.json.JsonOutput.toJson(pluginResults)
                    
                    echo "======== æ„å»ºç»“æœ ========"
                    echo "æˆåŠŸ: ${successCount} ä¸ª"
                    echo "å¤±è´¥: ${failedPlugins.size()} ä¸ª"
                    if (failedPlugins.size() > 0) {
                        echo "å¤±è´¥åˆ—è¡¨: ${failedPlugins.join(', ')}"
                    }
                }
            }
        }

        stage('å½’æ¡£åˆ¶å“') {
            steps {
                script {
                    def timestamp = new Date().format('yyyyMMdd_HHmmss')
                    def archiveDir = "${env.ARTIFACTS_DIR}/${timestamp}_build${env.BUILD_NUMBER}"
                    
                    sh """
                        echo "======== å½’æ¡£åˆ¶å“ ========"
                        
                        mkdir -p ${archiveDir}
                        
                        # å¤åˆ¶ .tgz æ–‡ä»¶åˆ°å½’æ¡£ç›®å½•
                        if [ -d "${YUEZHUO_DIR}/storage/tar/@huaiye" ]; then
                            cp ${YUEZHUO_DIR}/storage/tar/@huaiye/*.tgz ${archiveDir}/ 2>/dev/null || true
                        fi
                        
                        # åˆ›å»ºæ„å»ºä¿¡æ¯æ–‡ä»¶
                        cat > ${archiveDir}/BUILD_INFO.txt << EOF
Build Number: ${env.BUILD_NUMBER}
Plugins Commit: ${env.PLUGINS_COMMIT ?: 'N/A'}
Plugins Branch: ${params.PLUGINS_BRANCH}
Build Time: ${timestamp}
Plugin Count: ${env.PLUGIN_COUNT}
Success Count: ${env.SUCCESS_COUNT}
Failed Plugins: ${env.FAILED_PLUGINS}
Selected Plugins: ${env.PLUGIN_LIST.replace('\n', ', ')}
EOF
                        
                        echo "åˆ¶å“å·²å½’æ¡£åˆ°: ${archiveDir}"
                        ls -la ${archiveDir}/ || echo "å½’æ¡£ç›®å½•ä¸ºç©º"
                    """
                    
                    // Jenkins å½’æ¡£
                    archiveArtifacts artifacts: "${YUEZHUO_DIR}/storage/tar/@huaiye/*.tgz", allowEmptyArchive: true
                }
            }
        }

        stage('æ¸…ç†æ—§åˆ¶å“') {
            steps {
                script {
                    sh """
                        echo "======== æ¸…ç†è¶…è¿‡ 7 å¤©çš„æ—§åˆ¶å“ ========"
                        find ${ARTIFACTS_DIR} -maxdepth 1 -type d -mtime +7 -exec rm -rf {} \\; 2>/dev/null || true
                        echo "æ¸…ç†å®Œæˆ"
                        
                        echo "å½“å‰åˆ¶å“ç›®å½•:"
                        ls -lht ${ARTIFACTS_DIR}/ | head -20
                    """
                }
            }
        }
        
        stage('ç”ŸæˆæŠ¥å‘Š') {
            steps {
                script {
                    def buildTime = new Date().format('yyyy-MM-dd HH:mm:ss')
                    def pluginCount = env.PLUGIN_COUNT?.toInteger() ?: 0
                    def successCount = env.SUCCESS_COUNT?.toInteger() ?: 0
                    def failedCount = pluginCount - successCount
                    def successRate = pluginCount > 0 ? Math.round(successCount * 100.0 / pluginCount) : 0
                    def totalDuration = env.TOTAL_DURATION ?: "0"
                    
                    // æ ¼å¼åŒ–è€—æ—¶
                    def durationSec = totalDuration.toDouble()
                    def durationStr = durationSec >= 60 ? "${(durationSec / 60).intValue()}m ${(durationSec % 60).intValue()}s" : "${durationSec.intValue()}s"
                    
                    // è§£ææ’ä»¶ç»“æœï¼ˆè½¬ä¸ºå¯åºåˆ—åŒ–çš„æ™®é€šåˆ—è¡¨ï¼‰
                    def pluginResults = []
                    try {
                        def parsed = new groovy.json.JsonSlurper().parseText(env.PLUGIN_RESULTS ?: '[]')
                        // è½¬æ¢ä¸ºæ™®é€šçš„å¯åºåˆ—åŒ– Map
                        pluginResults = parsed.collect { item ->
                            [
                                name: item.name?.toString() ?: '',
                                version: item.version?.toString() ?: '',
                                status: item.status?.toString() ?: '',
                                error: item.error?.toString() ?: '',
                                duration: item.duration as int
                            ]
                        }
                    } catch (Exception e) {
                        echo "è§£ææ’ä»¶ç»“æœå¤±è´¥: ${e.message}"
                    }
                    
                    // ç”Ÿæˆæ’ä»¶è¡Œçš„ HTML
                    def pluginRowsHtml = pluginResults.collect { p ->
                        def statusClass = p.status == 'success' ? 'status-success' : 'status-failed'
                        def statusText = p.status == 'success' ? 'âœ“ æˆåŠŸ' : 'âœ— å¤±è´¥'
                        def logPeek = p.status == 'success' ? 'æ„å»ºæˆåŠŸ' : p.error
                        def logStyle = p.status == 'failed' ? 'color: #ef4444;' : ''
                        """
                        <tr>
                            <td><span class="plugin-name">${p.name}</span></td>
                            <td>${p.version}</td>
                            <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                            <td><div class="log-peek" style="${logStyle}">${logPeek}</div></td>
                            <td>${p.duration}s</td>
                        </tr>
                        """
                    }.join('')
                    
                    // ç”Ÿæˆ HTML æŠ¥å‘Š
                    def htmlReport = """<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yuezhuo æ’ä»¶æ„å»ºæŠ¥å‘Š #${env.BUILD_NUMBER}</title>
    <style>
        :root {
            --primary-color: #3b82f6;
            --success-color: #10b981;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
            --bg-color: #f3f4f6;
            --card-bg: #ffffff;
            --text-main: #1f2937;
            --text-secondary: #6b7280;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0; padding: 20px; line-height: 1.5;
        }
        .container { max-width: 1000px; margin: 0 auto; }
        .header-card {
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
            color: white; padding: 30px; border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            margin-bottom: 24px; display: flex;
            justify-content: space-between; align-items: center;
        }
        .header-project h1 { margin: 0; font-size: 24px; font-weight: 600; }
        .header-project p { margin: 8px 0 0; opacity: 0.9; font-size: 14px; }
        .build-badge {
            background-color: rgba(255,255,255,0.2);
            padding: 8px 16px; border-radius: 20px;
            font-weight: 500; backdrop-filter: blur(4px);
        }
        .stats-grid {
            display: grid; grid-template-columns: repeat(4, 1fr);
            gap: 20px; margin-bottom: 24px;
        }
        .stat-card {
            background: var(--card-bg); padding: 20px; border-radius: 10px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            text-align: center; border-top: 4px solid transparent;
        }
        .stat-card.total { border-color: var(--primary-color); }
        .stat-card.success { border-color: var(--success-color); }
        .stat-card.failed { border-color: var(--danger-color); }
        .stat-card.duration { border-color: var(--warning-color); }
        .stat-value { font-size: 32px; font-weight: 700; margin: 10px 0; }
        .stat-label { color: var(--text-secondary); font-size: 14px; text-transform: uppercase; letter-spacing: 0.05em; }
        .main-card {
            background: var(--card-bg); border-radius: 10px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            padding: 24px; margin-bottom: 24px;
        }
        .card-header {
            display: flex; justify-content: space-between; align-items: center;
            padding-bottom: 16px; border-bottom: 1px solid #e5e7eb; margin-bottom: 20px;
        }
        .card-title { font-size: 18px; font-weight: 600; color: var(--text-main); }
        .plugin-table { width: 100%; border-collapse: collapse; }
        .plugin-table th {
            text-align: left; padding: 12px; background-color: #f9fafb;
            color: var(--text-secondary); font-size: 13px; font-weight: 600;
            border-bottom: 1px solid #e5e7eb;
        }
        .plugin-table td { padding: 14px 12px; border-bottom: 1px solid #f3f4f6; vertical-align: middle; }
        .plugin-name { font-weight: 500; color: var(--primary-color); }
        .status-badge {
            display: inline-flex; align-items: center;
            padding: 4px 12px; border-radius: 9999px; font-size: 12px; font-weight: 500;
        }
        .status-success { background-color: #d1fae5; color: #065f46; }
        .status-failed { background-color: #fee2e2; color: #991b1b; }
        .log-peek {
            font-family: 'Courier New', monospace; font-size: 12px;
            color: var(--text-secondary); background: #f9fafb;
            padding: 8px; border-radius: 4px; max-width: 400px;
            overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
        }
        .progress-container {
            height: 8px; background-color: #e5e7eb; border-radius: 4px;
            margin-top: 10px; overflow: hidden;
        }
        .progress-bar { height: 100%; background-color: var(--success-color); transition: width 0.5s ease; }
        .footer { text-align: center; color: var(--text-secondary); font-size: 12px; margin-top: 40px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header-card">
            <div class="header-project">
                <h1>ğŸ“¦ Yuezhuo æ’ä»¶æ„å»ºæŠ¥å‘Š</h1>
                <p>æ„å»ºä»»åŠ¡: #${env.BUILD_NUMBER} &bull; ${buildTime}</p>
            </div>
            <div class="build-badge">
                åˆ†æ”¯: ${params.PLUGINS_BRANCH ?: 'master'}
            </div>
        </div>
        
        <div class="stats-grid">
            <div class="stat-card total">
                <div class="stat-value" style="color: var(--primary-color)">${pluginCount}</div>
                <div class="stat-label">æ€»æ’ä»¶æ•°</div>
            </div>
            <div class="stat-card success">
                <div class="stat-value" style="color: var(--success-color)">${successCount}</div>
                <div class="stat-label">æ„å»ºæˆåŠŸ</div>
            </div>
            <div class="stat-card failed">
                <div class="stat-value" style="color: var(--danger-color)">${failedCount}</div>
                <div class="stat-label">æ„å»ºå¤±è´¥</div>
            </div>
            <div class="stat-card duration">
                <div class="stat-value" style="color: var(--warning-color)">${durationStr}</div>
                <div class="stat-label">æ€»è€—æ—¶</div>
            </div>
        </div>
        
        <div class="main-card">
            <div class="card-header">
                <div class="card-title">æ’ä»¶æ„å»ºè¯¦æƒ…</div>
                <div style="font-size: 14px; color: var(--text-secondary);">
                    æˆåŠŸç‡: ${successRate}%
                </div>
            </div>
            <div class="progress-container">
                <div class="progress-bar" style="width: ${successRate}%"></div>
            </div>
            <table class="plugin-table" style="margin-top: 20px;">
                <thead>
                    <tr>
                        <th>æ’ä»¶åç§°</th>
                        <th>ç‰ˆæœ¬</th>
                        <th>çŠ¶æ€</th>
                        <th style="width: 40%">æ—¥å¿—æ‘˜è¦ / é”™è¯¯åŸå› </th>
                        <th>è€—æ—¶</th>
                    </tr>
                </thead>
                <tbody>
                    ${pluginRowsHtml}
                </tbody>
            </table>
        </div>
        
        <div class="footer">
            Generated by Jenkins CI &bull; Yuezhuo Plugin Build System
            <br><a href="${env.BUILD_URL}" style="color: var(--primary-color);">æŸ¥çœ‹å®Œæ•´æ„å»ºæ—¥å¿—</a>
        </div>
    </div>
</body>
</html>"""
                    
                    // ä¿å­˜æŠ¥å‘Šåˆ°å·¥ä½œç›®å½•
                    writeFile file: "${env.YUEZHUO_DIR}/build-report.html", text: htmlReport
                    
                    // å½’æ¡£æŠ¥å‘Š
                    archiveArtifacts artifacts: "${env.YUEZHUO_DIR}/build-report.html", allowEmptyArchive: true
                    
                    // ä¿å­˜é‚®ä»¶å†…å®¹ä¾› post é˜¶æ®µä½¿ç”¨
                    env.EMAIL_SUBJECT = "Yuezhuo æ’ä»¶æ„å»ºæŠ¥å‘Š #${env.BUILD_NUMBER} - ${failedCount > 0 ? 'éƒ¨åˆ†å¤±è´¥' : 'å…¨éƒ¨æˆåŠŸ'}"
                    env.BUILD_REPORT_PATH = "${env.YUEZHUO_DIR}/build-report.html"
                    
                    echo "æ„å»ºæŠ¥å‘Šå·²ç”Ÿæˆ: ${env.BUILD_REPORT_PATH}"
                }
            }
        }
    }

    post {
        always {
            script {
                def failedCount = (env.PLUGIN_COUNT?.toInteger() ?: 0) - (env.SUCCESS_COUNT?.toInteger() ?: 0)
                def statusEmoji = failedCount > 0 ? 'âš ï¸' : 'âœ…'
                def statusText = failedCount > 0 ? 'éƒ¨åˆ†å¤±è´¥' : 'å…¨éƒ¨æˆåŠŸ'
                
                // å‘é€é‚®ä»¶
                try {
                    // ç”Ÿæˆé‚®ä»¶ç‰ˆçš„æ’ä»¶è¡¨æ ¼è¡Œï¼ˆä½¿ç”¨å†…è”æ ·å¼ï¼‰
                    // æ³¨æ„: ä½¿ç”¨ JsonSlurper åç«‹å³å¤„ç†å®Œæ¯•ï¼Œä¸ä¿ç•™ LazyMap å¼•ç”¨
                    def emailPluginRows = ''
                    def pluginResultsJson = env.PLUGIN_RESULTS ?: '[]'
                    if (pluginResultsJson && pluginResultsJson != '[]') {
                        try {
                            // ç›´æ¥åœ¨ä¸€ä¸ªè¡¨è¾¾å¼ä¸­å®Œæˆè§£æå’Œè½¬æ¢ï¼Œé¿å…ä¿ç•™ LazyMap å¼•ç”¨
                            emailPluginRows = new groovy.json.JsonSlurper().parseText(pluginResultsJson).collect { item ->
                                def name = item.name?.toString() ?: ''
                                def version = item.version?.toString() ?: ''  
                                def status = item.status?.toString() ?: 'unknown'
                                def error = item.error?.toString() ?: ''
                                def duration = item.duration?.toString() ?: '0'
                                def statusIcon = status == 'success' ? 'âœ…' : 'âŒ'
                                def errorText = status == 'success' ? '-' : (error.take(50) ?: 'Unknown error')
                                """
                            <tr>
                                <td style="padding: 12px; border-bottom: 1px solid #e5e7eb; color: #3b82f6; font-weight: 500;">${name}</td>
                                <td style="padding: 12px; border-bottom: 1px solid #e5e7eb; font-size: 12px; color: #6b7280;">${version}</td>
                                <td style="padding: 12px; border-bottom: 1px solid #e5e7eb; text-align: center; font-size: 18px;">${statusIcon}</td>
                                <td style="padding: 12px; border-bottom: 1px solid #e5e7eb; font-size: 11px; color: #6b7280; font-family: monospace;">${errorText}</td>
                                <td style="padding: 12px; border-bottom: 1px solid #e5e7eb; font-size: 12px; color: #6b7280;">${duration}s</td>
                            </tr>
                                """
                            }.join('') // ç«‹å³ join æˆå­—ç¬¦ä¸²ï¼ŒGC ä¼šå›æ”¶ LazyMap
                        } catch (Exception pe) {
                            echo "Plugin data parsing error: ${pe.message}"
                            emailPluginRows = '<tr><td colspan="5" style="padding: 12px; text-align: center; color: #6b7280;">Plugin data unavailable</td></tr>'
                        }
                    } else {
                        emailPluginRows = '<tr><td colspan="5" style="padding: 12px; text-align: center; color: #6b7280;">No plugin data</td></tr>'
                    }
                    
                    def totalCount = env.PLUGIN_COUNT?.toInteger() ?: 0
                    def successCountVal = env.SUCCESS_COUNT?.toInteger() ?: 0
                    def successRateVal = totalCount > 0 ? Math.round(successCountVal * 100.0 / totalCount) : 0
                    def durationVal = env.TOTAL_DURATION ?: '0'
                    
                    emailext(
                        to: params.EMAIL_RECIPIENTS ?: 'wangting@huaiye.com.cn',
                        subject: "${statusEmoji} Yuezhuo Plugin Build #${env.BUILD_NUMBER} - ${statusText}",
                        mimeType: 'text/html',
                        recipientProviders: [
                            [$class: 'RequesterRecipientProvider']
                        ],
                        body: """
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
</head>
<body style="font-family: Arial, sans-serif; margin: 0; padding: 20px; background-color: #f3f4f6;">
    <table cellpadding="0" cellspacing="0" style="max-width: 700px; margin: 0 auto; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
        <!-- Header -->
        <tr>
            <td style="background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%); color: white; padding: 24px;">
                <h1 style="margin: 0; font-size: 22px;">Yuezhuo Plugin Build Report</h1>
                <p style="margin: 8px 0 0; opacity: 0.9; font-size: 14px;">Build #${env.BUILD_NUMBER} - ${new Date().format('yyyy-MM-dd HH:mm:ss')} - Branch: ${params.PLUGINS_BRANCH ?: 'master'}</p>
            </td>
        </tr>
        
        <!-- Stats -->
        <tr>
            <td style="padding: 24px;">
                <table cellpadding="0" cellspacing="0" style="width: 100%;">
                    <tr>
                        <td style="width: 25%; text-align: center; padding: 16px; background: #eff6ff; border-top: 4px solid #3b82f6;">
                            <div style="font-size: 28px; font-weight: bold; color: #3b82f6;">${totalCount}</div>
                            <div style="font-size: 11px; color: #6b7280; text-transform: uppercase;">TOTAL</div>
                        </td>
                        <td style="width: 4px;"></td>
                        <td style="width: 25%; text-align: center; padding: 16px; background: #f0fdf4; border-top: 4px solid #10b981;">
                            <div style="font-size: 28px; font-weight: bold; color: #10b981;">${successCountVal}</div>
                            <div style="font-size: 11px; color: #6b7280; text-transform: uppercase;">SUCCESS</div>
                        </td>
                        <td style="width: 4px;"></td>
                        <td style="width: 25%; text-align: center; padding: 16px; background: #fef2f2; border-top: 4px solid #ef4444;">
                            <div style="font-size: 28px; font-weight: bold; color: #ef4444;">${failedCount}</div>
                            <div style="font-size: 11px; color: #6b7280; text-transform: uppercase;">FAILED</div>
                        </td>
                        <td style="width: 4px;"></td>
                        <td style="width: 25%; text-align: center; padding: 16px; background: #fffbeb; border-top: 4px solid #f59e0b;">
                            <div style="font-size: 28px; font-weight: bold; color: #f59e0b;">${durationVal}s</div>
                            <div style="font-size: 11px; color: #6b7280; text-transform: uppercase;">DURATION</div>
                        </td>
                    </tr>
                </table>
                
                <!-- Progress Bar -->
                <div style="margin-top: 16px;">
                    <div style="display: flex; justify-content: space-between; font-size: 12px; color: #6b7280; margin-bottom: 4px;">
                        <span>Success Rate</span>
                        <span>${successRateVal}%</span>
                    </div>
                    <div style="height: 8px; background: #e5e7eb; border-radius: 4px; overflow: hidden;">
                        <div style="height: 100%; width: ${successRateVal}%; background: #10b981;"></div>
                    </div>
                </div>
            </td>
        </tr>
        
        <!-- Plugin Table -->
        <tr>
            <td style="padding: 0 24px 24px;">
                <div style="font-size: 16px; font-weight: 600; color: #1f2937; padding-bottom: 12px; border-bottom: 1px solid #e5e7eb; margin-bottom: 16px;">Plugin Details</div>
                <table cellpadding="0" cellspacing="0" style="width: 100%; border-collapse: collapse;">
                    <tr style="background: #f9fafb;">
                        <th style="padding: 10px 12px; text-align: left; font-size: 11px; color: #6b7280; font-weight: 600; text-transform: uppercase;">Plugin</th>
                        <th style="padding: 10px 12px; text-align: left; font-size: 11px; color: #6b7280; font-weight: 600; text-transform: uppercase;">Version</th>
                        <th style="padding: 10px 12px; text-align: left; font-size: 11px; color: #6b7280; font-weight: 600; text-transform: uppercase;">Status</th>
                        <th style="padding: 10px 12px; text-align: left; font-size: 11px; color: #6b7280; font-weight: 600; text-transform: uppercase;">Error</th>
                        <th style="padding: 10px 12px; text-align: left; font-size: 11px; color: #6b7280; font-weight: 600; text-transform: uppercase;">Time</th>
                    </tr>
                    ${emailPluginRows}
                </table>
            </td>
        </tr>
        
        <!-- Footer -->
        <tr>
            <td style="background: #f9fafb; padding: 16px; text-align: center;">
                <a href="${env.BUILD_URL}" style="display: inline-block; background: #3b82f6; color: white; padding: 10px 20px; text-decoration: none; border-radius: 6px; font-size: 13px; font-weight: 500;">View Build Log</a>
                <p style="margin: 12px 0 0; font-size: 11px; color: #9ca3af;">Generated by Jenkins CI - Yuezhuo Plugin Build System</p>
            </td>
        </tr>
    </table>
</body>
</html>
                        """
                    )
                    echo "Email sent successfully"
                } catch (Exception e) {
                    echo "Email failed: ${e.message}"
                }
            }
        }
        success {
            echo """
            ========================================
            âœ… æ’ä»¶æ‰“åŒ…æˆåŠŸï¼
            ========================================
            æ„å»ºå·: ${env.BUILD_NUMBER}
            æˆåŠŸæ‰“åŒ…: ${env.SUCCESS_COUNT} ä¸ªæ’ä»¶
            åˆ¶å“ç›®å½•: ${env.ARTIFACTS_DIR}
            æŠ¥å‘Š: ${env.BUILD_REPORT_PATH}
            ========================================
            """
        }
        failure {
            echo """
            ========================================
            âŒ æ’ä»¶æ‰“åŒ…å¤±è´¥ï¼
            ========================================
            è¯·æ£€æŸ¥æ§åˆ¶å°æ—¥å¿—è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯ã€‚
            ========================================
            """
        }
    }
}
