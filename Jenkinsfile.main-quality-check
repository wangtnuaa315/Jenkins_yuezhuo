/**
 * ============================================================================
 * Yuezhuo ä¸»å·¥ç¨‹ä»£ç è´¨é‡æ£€æŸ¥ä»»åŠ¡
 * ============================================================================
 * 
 * ã€åŠŸèƒ½è¯´æ˜ã€‘
 * - å¯¹ä¸»å·¥ç¨‹ä»£ç è¿›è¡Œè´¨é‡æ£€æŸ¥ï¼ˆESLintã€ç±»å‹æ£€æŸ¥ã€å®‰å…¨å®¡è®¡ï¼‰
 * - ç”Ÿæˆè¯¦ç»†æŠ¥å‘Šæ–‡ä»¶å¹¶å½’æ¡£
 * - å‘é€é‚®ä»¶é€šçŸ¥ï¼ˆå«è¯¦æƒ…é“¾æ¥ï¼‰
 * - ç‹¬ç«‹è¿è¡Œï¼Œä¸éœ€è¦å…ˆæ‰§è¡Œæ„å»ºä»»åŠ¡
 * 
 * ã€ä¾èµ–å…³ç³»ã€‘
 * - æ— ä¾èµ–ï¼Œå¯ç‹¬ç«‹è¿è¡Œ
 * 
 * ã€è¿è¡Œé¢‘ç‡ã€‘
 * - æ—¥å¸¸ä»£ç è´¨é‡æ£€æŸ¥ï¼Œå¯é¢‘ç¹è¿è¡Œ
 * 
 * ã€è¾“å‡ºã€‘
 * - eslint-report.txt: ESLint è¯¦ç»†æŠ¥å‘Š
 * - tsc-report.txt: TypeScript ç±»å‹æ£€æŸ¥æŠ¥å‘Š
 * - security-report.txt: å®‰å…¨å®¡è®¡æŠ¥å‘Š
 * - è´¨é‡æ£€æŸ¥æŠ¥å‘Šé‚®ä»¶ï¼ˆå«è¯¦æƒ…é“¾æ¥ï¼‰
 * 
 * ã€ç»´æŠ¤ä¿¡æ¯ã€‘
 * åˆ›å»ºæ—¶é—´ï¼š2026-02-06
 * ============================================================================
 */

pipeline {
    agent any

    parameters {
        string(
            name: 'YUEZHUO_BRANCH',
            defaultValue: 'develop',
            description: 'ä¸»å·¥ç¨‹åˆ†æ”¯'
        )
        string(
            name: 'EMAIL_RECIPIENTS',
            defaultValue: 'wangting@huaiye.com.cn',
            description: 'é‚®ä»¶æ”¶ä»¶äººï¼ˆå¤šä¸ªç”¨é€—å·åˆ†éš”ï¼‰'
        )
        booleanParam(
            name: 'RUN_ESLINT',
            defaultValue: true,
            description: 'è¿è¡Œ ESLint æ£€æŸ¥'
        )
        booleanParam(
            name: 'RUN_TYPE_CHECK',
            defaultValue: true,
            description: 'è¿è¡Œ TypeScript ç±»å‹æ£€æŸ¥'
        )
        booleanParam(
            name: 'RUN_SECURITY_AUDIT',
            defaultValue: true,
            description: 'è¿è¡Œä¾èµ–å®‰å…¨å®¡è®¡'
        )
    }

    environment {
        // å…±äº«å·¥ä½œç›®å½•
        SHARED_WORKSPACE = '/mnt/sdb3/yuezhuo-workspace'
        YUEZHUO_DIR = "${SHARED_WORKSPACE}/yuezhuo"
        YUEZHUO_REPO = 'http://192.168.1.6:9000/innovation/yuezhuo.git'
        GIT_CREDENTIALS = 'yuezhuo-git-credentials'
    }

    stages {
        stage('ç¯å¢ƒæ£€æŸ¥') {
            steps {
                script {
                    sh '''
                        echo "======== ç¯å¢ƒä¿¡æ¯ ========"
                        echo "Node: $(hostname)"
                        echo "Node.js: $(node -v)"
                        echo "Yarn: $(yarn -v)"
                        echo "åˆ†æ”¯: ''' + params.YUEZHUO_BRANCH + '''"
                        echo "========================="
                    '''
                }
            }
        }

        stage('æ£€æŸ¥ä»£ç ä»“åº“') {
            steps {
                script {
                    // æ£€æŸ¥ä»£ç ä»“åº“æ˜¯å¦å­˜åœ¨
                    def repoExists = sh(
                        script: "test -d ${YUEZHUO_DIR}/.git && echo 'yes' || echo 'no'",
                        returnStdout: true
                    ).trim()
                    
                    if (repoExists == 'yes') {
                        // ä»“åº“å·²å­˜åœ¨ï¼Œä½¿ç”¨å‡­è¯æ›´æ–°
                        dir(env.YUEZHUO_DIR) {
                            checkout([
                                $class: 'GitSCM',
                                branches: [[name: "*/${params.YUEZHUO_BRANCH}"]],
                                userRemoteConfigs: [[
                                    url: env.YUEZHUO_REPO,
                                    credentialsId: env.GIT_CREDENTIALS
                                ]]
                            ])
                        }
                        echo "ä»£ç ä»“åº“å·²æ›´æ–°åˆ° ${params.YUEZHUO_BRANCH} åˆ†æ”¯"
                    } else {
                        // ä»“åº“ä¸å­˜åœ¨ï¼Œå…‹éš†
                        echo "ä»£ç ä»“åº“ä¸å­˜åœ¨ï¼Œæ­£åœ¨å…‹éš†..."
                        sh "mkdir -p ${SHARED_WORKSPACE}"
                        dir(env.SHARED_WORKSPACE) {
                            checkout([
                                $class: 'GitSCM',
                                branches: [[name: "*/${params.YUEZHUO_BRANCH}"]],
                                extensions: [[
                                    $class: 'RelativeTargetDirectory',
                                    relativeTargetDir: 'yuezhuo'
                                ]],
                                userRemoteConfigs: [[
                                    url: env.YUEZHUO_REPO,
                                    credentialsId: env.GIT_CREDENTIALS
                                ]]
                            ])
                        }
                        echo "ä»£ç ä»“åº“å…‹éš†å®Œæˆ"
                    }
                }
            }
        }

        stage('å®‰è£…ä¾èµ–') {
            steps {
                script {
                    dir(env.YUEZHUO_DIR) {
                        // æ£€æŸ¥ node_modules æ˜¯å¦å­˜åœ¨ï¼Œä¸å­˜åœ¨åˆ™å®‰è£…
                        def hasNodeModules = sh(
                            script: "test -d node_modules && echo 'yes' || echo 'no'",
                            returnStdout: true
                        ).trim()
                        
                        if (hasNodeModules == 'no') {
                            echo "node_modules ä¸å­˜åœ¨ï¼Œæ­£åœ¨å®‰è£…ä¾èµ–..."
                            sh 'yarn install --frozen-lockfile'
                        } else {
                            echo "node_modules å·²å­˜åœ¨ï¼Œè·³è¿‡å®‰è£…"
                        }
                    }
                }
            }
        }

        stage('è·å–ä»£ç ä¿¡æ¯') {
            steps {
                script {
                    dir(env.YUEZHUO_DIR) {
                        env.COMMIT_HASH = sh(script: 'git rev-parse HEAD', returnStdout: true).trim()
                        env.COMMIT_SHORT = sh(script: 'git rev-parse --short HEAD', returnStdout: true).trim()
                        env.CURRENT_BRANCH = sh(script: 'git branch --show-current || git rev-parse --abbrev-ref HEAD', returnStdout: true).trim()
                        
                        echo """
                        ========================================
                        ä»£ç ä¿¡æ¯ï¼š
                        - åˆ†æ”¯: ${env.CURRENT_BRANCH}
                        - Commit: ${env.COMMIT_SHORT}
                        ========================================
                        """
                    }
                }
            }
        }

        stage('ESLint æ£€æŸ¥') {
            when {
                expression { params.RUN_ESLINT == true }
            }
            steps {
                script {
                    def startTime = System.currentTimeMillis()
                    
                    dir(env.YUEZHUO_DIR) {
                        // ä½¿ç”¨é¡¹ç›®è‡ªå¸¦çš„ lint å‘½ä»¤ï¼Œé¿å…è·¯å¾„åŒ¹é…é—®é¢˜
                        sh '''
                            # è¶…æ—¶ 10 åˆ†é’Ÿï¼Œä½¿ç”¨é¡¹ç›®è‡ªå¸¦çš„ lint å‘½ä»¤
                            # å¦‚æœé¡¹ç›®æœ‰ yarn lint å‘½ä»¤åˆ™ä½¿ç”¨ï¼Œå¦åˆ™ç›´æ¥è¿è¡Œ eslint
                            if yarn run --non-interactive lint --help > /dev/null 2>&1; then
                                timeout 600 yarn lint > "${WORKSPACE}/eslint-output.txt" 2>&1 || true
                            else
                                # å›é€€æ–¹æ¡ˆï¼šç›´æ¥æ‰«æ packages å’Œ src ç›®å½•
                                timeout 600 yarn eslint . \
                                    --ext .ts,.tsx,.js,.jsx \
                                    --ignore-pattern "node_modules" \
                                    --ignore-pattern "dist" \
                                    --ignore-pattern "lib" \
                                    --ignore-pattern "es" \
                                    --ignore-pattern "*.d.ts" \
                                    --format stylish > "${WORKSPACE}/eslint-output.txt" 2>&1 || true
                            fi
                            
                            # ä½¿ç”¨ Python ç”ŸæˆæŠ¥å‘Šï¼ˆUTF-8 with BOMï¼Œè§£å†³ä¸­æ–‡ä¹±ç ï¼‰
                            python3 << 'PYTHON_SCRIPT'
import os
import re

workspace = os.environ.get('WORKSPACE', '/tmp')
input_file = os.path.join(workspace, 'eslint-output.txt')
output_file = os.path.join(workspace, 'eslint-report.txt')
NL = chr(10)

try:
    with open(input_file, 'r', encoding='utf-8', errors='ignore') as f:
        content = f.read()
    
    # ç»Ÿè®¡é”™è¯¯å’Œè­¦å‘Šæ•°é‡
    error_count = len(re.findall(r' error ', content))
    warn_count = len(re.findall(r' warning ', content))
    
    # ç”ŸæˆæŠ¥å‘Šæ–‡ä»¶ï¼ˆUTF-8 with BOMï¼‰
    with open(output_file, 'w', encoding='utf-8-sig') as out:
        out.write('=' * 70 + NL)
        out.write('ESLint ä»£ç æ£€æŸ¥è¯¦ç»†æŠ¥å‘Š' + NL)
        out.write('=' * 70 + NL + NL)
        out.write('ç»Ÿè®¡: {} ä¸ªé”™è¯¯, {} ä¸ªè­¦å‘Š'.format(error_count, warn_count) + NL + NL)
        
        # è¿½åŠ å®Œæ•´åŸå§‹è¾“å‡º
        out.write('--- è¯¦ç»†è¾“å‡º ---' + NL)
        for line in content.splitlines():
            out.write(line + NL)
    
    print('ESLINT_ERRORS={}'.format(error_count))
    print('ESLINT_WARNINGS={}'.format(warn_count))

except Exception as ex:
    print('ESLINT_ERRORS=0')
    print('ESLINT_WARNINGS=0')
    with open(output_file, 'w', encoding='utf-8-sig') as out:
        out.write('ESLint æ£€æŸ¥æ‰§è¡Œå¤±è´¥: {}'.format(str(ex)) + NL)
PYTHON_SCRIPT
                        '''
                    }
                    
                    // ä» stylish è¾“å‡ºè§£æç»Ÿè®¡
                    def errors = 0
                    def warnings = 0
                    try {
                        def statsOutput = sh(script: '''
                            grep -oE "[0-9]+ errors?" ${WORKSPACE}/eslint-output.txt | head -1 | grep -oE "[0-9]+" || echo "0"
                        ''', returnStdout: true).trim()
                        errors = statsOutput.toInteger()
                        
                        def warnOutput = sh(script: '''
                            grep -oE "[0-9]+ warnings?" ${WORKSPACE}/eslint-output.txt | head -1 | grep -oE "[0-9]+" || echo "0"
                        ''', returnStdout: true).trim()
                        warnings = warnOutput.toInteger()
                    } catch (Exception e) {
                        echo "è§£æ ESLint ç»“æœå¤±è´¥: ${e.message}"
                    }
                    
                    def eslintDuration = (System.currentTimeMillis() - startTime) / 1000
                    def eslintResult = errors > 0 ? 'failed' : (warnings > 0 ? 'warning' : 'success')
                    
                    env.ESLINT_RESULT = eslintResult
                    env.ESLINT_ERRORS = errors.toString()
                    env.ESLINT_WARNINGS = warnings.toString()
                    env.ESLINT_DURATION = eslintDuration.toString()
                    
                    echo """
                    ========================================
                    ESLint æ£€æŸ¥ç»“æœ: ${eslintResult}
                    - é”™è¯¯: ${errors}
                    - è­¦å‘Š: ${warnings}
                    - è€—æ—¶: ${eslintDuration}s
                    ========================================
                    """
                }
            }
        }

        stage('TypeScript ç±»å‹æ£€æŸ¥') {
            when {
                expression { params.RUN_TYPE_CHECK == true }
            }
            steps {
                script {
                    def startTime = System.currentTimeMillis()
                    
                    dir(env.YUEZHUO_DIR) {
                        // æ‰§è¡Œç±»å‹æ£€æŸ¥å¹¶ç”ŸæˆæŠ¥å‘Š
                        sh '''
                            set +e  # ç¦ç”¨é”™è¯¯é€€å‡ºï¼Œç¡®ä¿ç±»å‹é”™è¯¯ä¸ä¼šå¯¼è‡´æ„å»ºå¤±è´¥
                            # æ‰§è¡Œ tsc å¹¶æ•è·è¾“å‡ºåˆ° WORKSPACE ç›®å½•
                            yarn tsc --noEmit > "${WORKSPACE}/tsc-output.txt" 2>&1 || true
                            set -e
                            
                            # ä½¿ç”¨ Python ç”ŸæˆæŠ¥å‘Šï¼ˆä½¿ç”¨ os.environ è·å– WORKSPACEï¼‰
                            python3 << 'PYTHON_SCRIPT'
import os

workspace = os.environ.get('WORKSPACE', '/tmp')
input_file = os.path.join(workspace, 'tsc-output.txt')
output_file = os.path.join(workspace, 'tsc-report.txt')
NL = chr(10)  # æ¢è¡Œç¬¦

try:
    with open(input_file, 'r', encoding='utf-8', errors='ignore') as f:
        content = f.read()
    
    # è§£æé”™è¯¯
    errors = []
    for line in content.splitlines():
        if 'error TS' in line:
            errors.append(line.strip())
    
    # ç”ŸæˆæŠ¥å‘Šæ–‡ä»¶ï¼ˆUTF-8 with BOMï¼‰
    with open(output_file, 'w', encoding='utf-8-sig') as out:
        out.write('=' * 70 + NL)
        out.write('TypeScript ç±»å‹æ£€æŸ¥è¯¦ç»†æŠ¥å‘Š' + NL)
        out.write('=' * 70 + NL + NL)
        out.write('ç»Ÿè®¡: {} ä¸ªç±»å‹é”™è¯¯'.format(len(errors)) + NL + NL)
        
        if errors:
            out.write('--- é”™è¯¯åˆ—è¡¨ï¼ˆå…± {} æ¡ï¼‰---'.format(len(errors)) + NL)
            for i, e in enumerate(errors, 1):
                out.write('{}. {}'.format(i, e) + NL)
        else:
            out.write(NL + 'âœ… æ²¡æœ‰å‘ç°ç±»å‹é”™è¯¯ï¼' + NL)
    
    print('TSC_ERRORS={}'.format(len(errors)))

except Exception as ex:
    print('TSC_ERRORS=0')
    with open(output_file, 'w', encoding='utf-8-sig') as out:
        out.write('TypeScript æ£€æŸ¥æ‰§è¡Œå¤±è´¥: {}'.format(str(ex)) + NL)
PYTHON_SCRIPT
                        '''
                    }
                    
                    // è§£æç»“æœ
                    def typeErrors = 0
                    try {
                        def output = sh(script: "grep -c 'error TS' ${WORKSPACE}/tsc-output.txt || echo '0'", returnStdout: true).trim()
                        typeErrors = output.toInteger()
                    } catch (Exception e) {
                        echo "è§£æ TSC ç»“æœå¤±è´¥: ${e.message}"
                    }
                    
                    def tscDuration = (System.currentTimeMillis() - startTime) / 1000
                    def tscResult = typeErrors > 0 ? 'failed' : 'success'
                    
                    env.TSC_RESULT = tscResult
                    env.TSC_ERRORS = typeErrors.toString()
                    env.TSC_DURATION = tscDuration.toString()
                    
                    echo """
                    ========================================
                    TypeScript ç±»å‹æ£€æŸ¥ç»“æœ: ${tscResult}
                    - ç±»å‹é”™è¯¯: ${typeErrors}
                    - è€—æ—¶: ${tscDuration}s
                    ========================================
                    """
                }
            }
        }

        stage('ä¾èµ–å®‰å…¨å®¡è®¡') {
            when {
                expression { params.RUN_SECURITY_AUDIT == true }
            }
            steps {
                script {
                    def startTime = System.currentTimeMillis()
                    
                    dir(env.YUEZHUO_DIR) {
                        sh '''
                            # æ‰§è¡Œå®‰å…¨å®¡è®¡
                            yarn audit --json > "${WORKSPACE}/audit-output.json" 2>&1 || true
                            
                            # ä½¿ç”¨ Python è§£æå¹¶ç”ŸæˆæŠ¥å‘Šï¼ˆä½¿ç”¨ os.environ è·å– WORKSPACEï¼‰
                            python3 << 'PYTHON_SCRIPT'
import json
import os

workspace = os.environ.get('WORKSPACE', '/tmp')
input_file = os.path.join(workspace, 'audit-output.json')
output_file = os.path.join(workspace, 'security-report.txt')
NL = chr(10)  # æ¢è¡Œç¬¦

try:
    with open(input_file, 'r', encoding='utf-8', errors='ignore') as f:
        content = f.read()
    
    critical = 0
    high = 0
    moderate = 0
    low = 0
    vulnerabilities = []
    
    for line in content.splitlines():
        if not line.strip():
            continue
        try:
            item = json.loads(line)
            if item.get('type') == 'auditAdvisory':
                data = item.get('data', {}).get('advisory', {})
                severity = data.get('severity', '')
                title = data.get('title', 'Unknown')
                module = data.get('module_name', 'unknown')
                
                if severity == 'critical':
                    critical += 1
                elif severity == 'high':
                    high += 1
                elif severity == 'moderate':
                    moderate += 1
                elif severity == 'low':
                    low += 1
                
                vulnerabilities.append({
                    'severity': severity.upper(),
                    'module': module,
                    'title': title[:80]
                })
        except:
            pass
    
    # ç”ŸæˆæŠ¥å‘Šæ–‡ä»¶ï¼ˆUTF-8 with BOMï¼‰
    with open(output_file, 'w', encoding='utf-8-sig') as out:
        out.write('=' * 70 + NL)
        out.write('ä¾èµ–å®‰å…¨å®¡è®¡è¯¦ç»†æŠ¥å‘Š' + NL)
        out.write('=' * 70 + NL + NL)
        out.write('ç»Ÿè®¡: {} ä¸¥é‡, {} é«˜å±, {} ä¸­å±, {} ä½å±'.format(critical, high, moderate, low) + NL + NL)
        
        if vulnerabilities:
            # æŒ‰ä¸¥é‡ç¨‹åº¦æ’åºå’Œåˆ†ç»„
            severity_order = {'CRITICAL': 0, 'HIGH': 1, 'MODERATE': 2, 'LOW': 3}
            vulnerabilities.sort(key=lambda x: severity_order.get(x['severity'], 99))
            
            out.write('--- æ¼æ´åˆ—è¡¨ï¼ˆæŒ‰ä¸¥é‡ç¨‹åº¦æ’åºï¼Œå…± {} æ¡ï¼‰---'.format(len(vulnerabilities)) + NL)
            
            # åˆ†ç±»æ˜¾ç¤ºæ‰€æœ‰æ¼æ´
            current_severity = None
            count = 0
            for v in vulnerabilities:
                if v['severity'] != current_severity:
                    current_severity = v['severity']
                    severity_count = len([x for x in vulnerabilities if x['severity'] == current_severity])
                    out.write(NL + 'ã€{} - {} æ¡ã€‘'.format(current_severity, severity_count) + NL)
                    count = 0
                count += 1
                out.write('  {}. {} - {}'.format(count, v['module'], v['title']) + NL)
        else:
            out.write(NL + 'âœ… æ²¡æœ‰å‘ç°å®‰å…¨æ¼æ´ï¼' + NL)
    
    print('AUDIT_CRITICAL={}'.format(critical))
    print('AUDIT_HIGH={}'.format(high))
    print('AUDIT_MODERATE={}'.format(moderate))
    print('AUDIT_LOW={}'.format(low))

except Exception as ex:
    print('AUDIT_CRITICAL=0')
    print('AUDIT_HIGH=0')
    print('AUDIT_MODERATE=0')
    print('AUDIT_LOW=0')
    with open(output_file, 'w', encoding='utf-8-sig') as out:
        out.write('å®‰å…¨å®¡è®¡æ‰§è¡Œå¤±è´¥: {}'.format(str(ex)) + NL)
PYTHON_SCRIPT
                        '''
                    }
                    
                    // è§£æç»“æœ
                    def critical = 0, high = 0, moderate = 0, low = 0
                    try {
                        def output = sh(script: '''
                            python3 -c "
import json
import os
workspace = os.environ.get('WORKSPACE', '/tmp')
input_file = os.path.join(workspace, 'audit-output.json')
c=h=m=l=0
try:
    with open(input_file, 'r') as f:
        for line in f:
            try:
                item = json.loads(line)
                if item.get('type') == 'auditAdvisory':
                    s = item.get('data',{}).get('advisory',{}).get('severity','')
                    if s=='critical': c+=1
                    elif s=='high': h+=1
                    elif s=='moderate': m+=1
                    elif s=='low': l+=1
            except: pass
except: pass
print('C={} H={} M={} L={}'.format(c,h,m,l))
"
                        ''', returnStdout: true).trim()
                        
                        def match = (output =~ /C=(\d+) H=(\d+) M=(\d+) L=(\d+)/)
                        if (match.find()) {
                            critical = match.group(1).toInteger()
                            high = match.group(2).toInteger()
                            moderate = match.group(3).toInteger()
                            low = match.group(4).toInteger()
                        }
                    } catch (Exception e) {
                        echo "è§£æå®‰å…¨å®¡è®¡ç»“æœå¤±è´¥: ${e.message}"
                    }
                    
                    def auditDuration = (System.currentTimeMillis() - startTime) / 1000
                    def auditResult = (critical > 0 || high > 0) ? 'failed' : (moderate > 0 ? 'warning' : 'success')
                    
                    env.AUDIT_RESULT = auditResult
                    env.AUDIT_CRITICAL = critical.toString()
                    env.AUDIT_HIGH = high.toString()
                    env.AUDIT_MODERATE = moderate.toString()
                    env.AUDIT_LOW = low.toString()
                    env.AUDIT_DURATION = auditDuration.toString()
                    
                    echo """
                    ========================================
                    ä¾èµ–å®‰å…¨å®¡è®¡ç»“æœ: ${auditResult}
                    - ä¸¥é‡: ${critical}
                    - é«˜å±: ${high}
                    - ä¸­å±: ${moderate}
                    - ä½å±: ${low}
                    - è€—æ—¶: ${auditDuration}s
                    ========================================
                    """
                }
            }
        }

        stage('å½’æ¡£æŠ¥å‘Š') {
            steps {
                script {
                    // å½’æ¡£æ‰€æœ‰æŠ¥å‘Šæ–‡ä»¶
                    archiveArtifacts artifacts: 'eslint-report.txt,tsc-report.txt,security-report.txt', allowEmptyArchive: true
                    echo "æŠ¥å‘Šæ–‡ä»¶å·²å½’æ¡£"
                }
            }
        }
    }

    post {
        always {
            script {
                def buildTime = new Date().format('yyyy-MM-dd HH:mm:ss')
                def buildUrl = env.BUILD_URL ?: ''
                
                // ç¡®å®šæ•´ä½“çŠ¶æ€
                def eslintResult = env.ESLINT_RESULT ?: 'skipped'
                def tscResult = env.TSC_RESULT ?: 'skipped'
                def auditResult = env.AUDIT_RESULT ?: 'skipped'
                
                def overallStatus = 'success'
                if (eslintResult == 'failed' || tscResult == 'failed' || auditResult == 'failed') {
                    overallStatus = 'failed'
                } else if (eslintResult == 'warning' || auditResult == 'warning') {
                    overallStatus = 'warning'
                }
                
                def statusEmoji = overallStatus == 'success' ? 'âœ…' : (overallStatus == 'warning' ? 'âš ï¸' : 'âŒ')
                def statusText = overallStatus == 'success' ? 'é€šè¿‡' : (overallStatus == 'warning' ? 'æœ‰è­¦å‘Š' : 'å¤±è´¥')
                
                // çŠ¶æ€å›¾æ ‡å’Œé¢œè‰²
                def eslintIcon = eslintResult == 'success' ? 'âœ“ é€šè¿‡' : (eslintResult == 'warning' ? 'âš  è­¦å‘Š' : (eslintResult == 'skipped' ? 'â­ è·³è¿‡' : 'âœ— é”™è¯¯'))
                def tscIcon = tscResult == 'success' ? 'âœ“ é€šè¿‡' : (tscResult == 'skipped' ? 'â­ è·³è¿‡' : 'âœ— é”™è¯¯')
                def auditIcon = auditResult == 'success' ? 'âœ“ é€šè¿‡' : (auditResult == 'warning' ? 'âš  æ¼æ´' : (auditResult == 'skipped' ? 'â­ è·³è¿‡' : 'âœ— æ¼æ´'))
                
                def eslintBadgeClass = eslintResult == 'success' ? 'badge-success' : (eslintResult == 'warning' ? 'badge-warning' : (eslintResult == 'skipped' ? 'badge-skip' : 'badge-danger'))
                def tscBadgeClass = tscResult == 'success' ? 'badge-success' : (tscResult == 'skipped' ? 'badge-skip' : 'badge-danger')
                def auditBadgeClass = auditResult == 'success' ? 'badge-success' : (auditResult == 'warning' ? 'badge-warning' : (auditResult == 'skipped' ? 'badge-skip' : 'badge-danger'))
                
                // å‘é€é‚®ä»¶
                try {
                    mail(
                        to: params.EMAIL_RECIPIENTS ?: 'wangting@huaiye.com.cn',
                        subject: "${statusEmoji} Yuezhuo ä¸»å·¥ç¨‹è´¨é‡æ£€æŸ¥ #${env.BUILD_NUMBER} - ${statusText}",
                        mimeType: 'text/html',
                        body: """
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <style>
        .container { max-width: 600px; margin: 0 auto; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        .header { background: linear-gradient(135deg, #7c3aed 0%, #a855f7 100%); color: white; padding: 20px; border-radius: 12px 12px 0 0; }
        .content { background: white; padding: 20px; border: 1px solid #e5e7eb; }
        .footer { background: #f9fafb; padding: 16px; text-align: center; border-radius: 0 0 12px 12px; border: 1px solid #e5e7eb; border-top: none; }
        .stat-box { display: inline-block; text-align: center; padding: 16px 24px; margin: 4px; border-radius: 8px; min-width: 80px; }
        .stat-value { font-size: 28px; font-weight: bold; }
        .stat-label { font-size: 11px; color: #6b7280; margin-top: 4px; }
        .check-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; border-bottom: 1px solid #f3f4f6; }
        .check-name { font-weight: 600; color: #1f2937; }
        .check-detail { font-size: 12px; color: #6b7280; margin-top: 2px; }
        .badge { padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 500; }
        .badge-success { background: #d1fae5; color: #065f46; }
        .badge-warning { background: #fef3c7; color: #92400e; }
        .badge-danger { background: #fee2e2; color: #991b1b; }
        .badge-skip { background: #f3f4f6; color: #6b7280; }
        .btn { display: inline-block; padding: 10px 20px; background: #7c3aed; color: white; text-decoration: none; border-radius: 6px; font-size: 13px; font-weight: 500; }
        .btn-secondary { background: #6b7280; margin-left: 8px; }
        .reference { background: #eff6ff; padding: 12px; border-radius: 6px; font-size: 12px; color: #1e40af; margin-top: 16px; }
    </style>
</head>
<body style="background: #f3f4f6; margin: 0; padding: 20px;">
    <div class="container">
        <div class="header">
            <h1 style="margin: 0; font-size: 20px;">${statusEmoji} ä»£ç è´¨é‡æŠ¥å‘Š</h1>
            <p style="margin: 8px 0 0; opacity: 0.9; font-size: 13px;">æ„å»º #${env.BUILD_NUMBER} â€¢ ${env.JOB_NAME} â€¢ ${buildTime}</p>
            <p style="margin: 4px 0 0; opacity: 0.8; font-size: 12px;">ğŸ“¦ ${env.CURRENT_BRANCH ?: params.YUEZHUO_BRANCH} (${env.COMMIT_SHORT ?: 'N/A'})</p>
        </div>
        
        <div class="content">
            <!-- ç»Ÿè®¡æ•°æ® -->
            <div style="text-align: center; margin-bottom: 20px;">
                <div class="stat-box" style="background: ${(env.ESLINT_ERRORS?.toInteger() ?: 0) > 0 ? '#fee2e2' : '#d1fae5'};">
                    <div class="stat-value" style="color: ${(env.ESLINT_ERRORS?.toInteger() ?: 0) > 0 ? '#ef4444' : '#10b981'};">${env.ESLINT_ERRORS ?: '0'}</div>
                    <div class="stat-label">ESLint é”™è¯¯</div>
                </div>
                <div class="stat-box" style="background: ${(env.ESLINT_WARNINGS?.toInteger() ?: 0) > 0 ? '#fef3c7' : '#d1fae5'};">
                    <div class="stat-value" style="color: ${(env.ESLINT_WARNINGS?.toInteger() ?: 0) > 0 ? '#f59e0b' : '#10b981'};">${env.ESLINT_WARNINGS ?: '0'}</div>
                    <div class="stat-label">ESLint è­¦å‘Š</div>
                </div>
                <div class="stat-box" style="background: ${(env.TSC_ERRORS?.toInteger() ?: 0) > 0 ? '#fee2e2' : '#d1fae5'};">
                    <div class="stat-value" style="color: ${(env.TSC_ERRORS?.toInteger() ?: 0) > 0 ? '#ef4444' : '#10b981'};">${env.TSC_ERRORS ?: '0'}</div>
                    <div class="stat-label">ç±»å‹é”™è¯¯</div>
                </div>
                <div class="stat-box" style="background: ${((env.AUDIT_CRITICAL?.toInteger() ?: 0) + (env.AUDIT_HIGH?.toInteger() ?: 0)) > 0 ? '#fee2e2' : '#d1fae5'};">
                    <div class="stat-value" style="color: ${((env.AUDIT_CRITICAL?.toInteger() ?: 0) + (env.AUDIT_HIGH?.toInteger() ?: 0)) > 0 ? '#ef4444' : '#10b981'};">${(env.AUDIT_CRITICAL?.toInteger() ?: 0) + (env.AUDIT_HIGH?.toInteger() ?: 0)}</div>
                    <div class="stat-label">é«˜å±æ¼æ´</div>
                </div>
            </div>
            
            <!-- æ£€æŸ¥é¡¹åˆ—è¡¨ -->
            <div class="check-item">
                <div>
                    <div class="check-name">ESLint ä»£ç è§„èŒƒ</div>
                    <div class="check-detail">${env.ESLINT_ERRORS ?: '0'} é”™è¯¯, ${env.ESLINT_WARNINGS ?: '0'} è­¦å‘Š, è€—æ—¶ ${env.ESLINT_DURATION ?: '0'}s</div>
                </div>
                <span class="badge ${eslintBadgeClass}">${eslintIcon}</span>
            </div>
            
            <div class="check-item">
                <div>
                    <div class="check-name">TypeScript ç±»å‹æ£€æŸ¥</div>
                    <div class="check-detail">${env.TSC_ERRORS ?: '0'} ä¸ªç±»å‹é”™è¯¯, è€—æ—¶ ${env.TSC_DURATION ?: '0'}s</div>
                </div>
                <span class="badge ${tscBadgeClass}">${tscIcon}</span>
            </div>
            
            <div class="check-item">
                <div>
                    <div class="check-name">ä¾èµ–å®‰å…¨æ‰«æ</div>
                    <div class="check-detail">${env.AUDIT_CRITICAL ?: '0'} ä¸¥é‡, ${env.AUDIT_HIGH ?: '0'} é«˜å±, ${env.AUDIT_MODERATE ?: '0'} ä¸­å±, ${env.AUDIT_LOW ?: '0'} ä½å±</div>
                </div>
                <span class="badge ${auditBadgeClass}">${auditIcon}</span>
            </div>
            
            <div class="reference">
                <strong>ğŸ“Š å‚è€ƒèŒƒå›´:</strong> ESLint é”™è¯¯=0 ä¸ºé€šè¿‡ | ç±»å‹é”™è¯¯=0 ä¸ºé€šè¿‡ | é«˜å±æ¼æ´=0 ä¸ºé€šè¿‡
            </div>
            
            <!-- æ“ä½œæŒ‰é’® -->
            <div style="margin-top: 20px;">
                <a href="${buildUrl}" class="btn">æŸ¥çœ‹å®Œæ•´æŠ¥å‘Š â†’</a>
                <a href="${buildUrl}artifact/eslint-report.txt" class="btn btn-secondary">ğŸ“„ ESLint è¯¦æƒ…</a>
                <a href="${buildUrl}artifact/tsc-report.txt" class="btn btn-secondary">ğŸ“„ ç±»å‹è¯¦æƒ…</a>
                <a href="${buildUrl}artifact/security-report.txt" class="btn btn-secondary">ğŸ›¡ï¸ æ¼æ´è¯¦æƒ…</a>
            </div>
        </div>
        
        <div class="footer">
            <p style="margin: 0; font-size: 11px; color: #9ca3af;">Generated by Jenkins CI â€¢ Yuezhuo ä¸»å·¥ç¨‹è´¨é‡æ£€æŸ¥</p>
        </div>
    </div>
</body>
</html>
                        """
                    )
                    echo "é‚®ä»¶å‘é€æˆåŠŸ"
                } catch (Exception e) {
                    echo "é‚®ä»¶å‘é€å¤±è´¥: ${e.message}"
                }
            }
        }
        success {
            echo """
            ========================================
            âœ… ä»£ç è´¨é‡æ£€æŸ¥å®Œæˆï¼
            ========================================
            åˆ†æ”¯: ${env.CURRENT_BRANCH}
            Commit: ${env.COMMIT_SHORT}
            ESLint: ${env.ESLINT_RESULT ?: 'skipped'}
            TypeScript: ${env.TSC_RESULT ?: 'skipped'}
            å®‰å…¨å®¡è®¡: ${env.AUDIT_RESULT ?: 'skipped'}
            ========================================
            """
        }
        failure {
            echo """
            ========================================
            âŒ ä»£ç è´¨é‡æ£€æŸ¥å¤±è´¥ï¼
            ========================================
            è¯·æ£€æŸ¥æ§åˆ¶å°æ—¥å¿—è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯ã€‚
            ========================================
            """
        }
    }
}
